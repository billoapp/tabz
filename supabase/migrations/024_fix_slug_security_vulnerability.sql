-- ============================================
-- CRITICAL SECURITY FIX: Bar Slug Uniqueness
-- ============================================
-- This migration fixes the security vulnerability where multiple bars
-- could have the same slug, causing customers to be directed to wrong bars

-- First, identify any existing slug collisions
WITH slug_collisions AS (
  SELECT 
    slug,
    COUNT(*) as collision_count,
    array_agg(id ORDER BY created_at) as bar_ids,
    array_agg(name ORDER BY created_at) as bar_names
  FROM bars 
  WHERE slug IS NOT NULL AND slug != ''
  GROUP BY slug
  HAVING COUNT(*) > 1
)
SELECT 
  'COLLISION DETECTED' as status,
  slug,
  collision_count,
  bar_ids,
  bar_names
FROM slug_collisions;

-- Create a backup of existing bars with their slugs
CREATE TABLE IF NOT EXISTS bars_slug_backup AS 
SELECT id, name, slug, created_at FROM bars WHERE slug IS NOT NULL;

-- Add proper slug column if it doesn't exist (for safety)
DO $$
BEGIN
  IF NOT EXISTS (
    SELECT 1 FROM information_schema.columns 
    WHERE table_name = 'bars' AND column_name = 'slug'
  ) THEN
    ALTER TABLE bars ADD COLUMN slug TEXT;
  END IF;
END $$;

-- Fix existing collisions by appending bar IDs to slugs
UPDATE bars b1
SET slug = b1.slug || '-' || substring(b1.id::text, 1, 8)
FROM bars b2
WHERE b1.slug = b2.slug 
  AND b1.id != b2.id
  AND b1.slug IS NOT NULL 
  AND b1.slug != ''
  AND b1.created_at > b2.created_at;

-- Add UNIQUE constraint to prevent future collisions
ALTER TABLE bars 
ADD CONSTRAINT bars_slug_unique UNIQUE (slug);

-- Create index for performance if it doesn't exist
CREATE INDEX IF NOT EXISTS idx_bars_slug ON bars(slug);

-- Add proper validation function for slug generation
CREATE OR REPLACE FUNCTION generate_unique_slug(p_name TEXT, p_existing_id UUID DEFAULT NULL)
RETURNS TEXT AS $$
DECLARE
  base_slug TEXT;
  unique_slug TEXT;
  counter INTEGER := 1;
  max_attempts INTEGER := 100;
BEGIN
  -- Generate base slug from name
  base_slug := lower(trim(p_name));
  base_slug := regexp_replace(base_slug, '[^a-z0-9]+', '-', 'g');
  base_slug := regexp_replace(base_slug, '^-+|-+$', '', 'g');
  base_slug := substring(base_slug, 1, 50);
  
  -- If base_slug is empty, use a default
  IF base_slug IS NULL OR base_slug = '' THEN
    base_slug := 'bar';
  END IF;
  
  -- Start with base slug
  unique_slug := base_slug;
  
  -- Loop until we find a unique slug
  WHILE counter <= max_attempts LOOP
    -- Check if slug is unique (excluding current bar if updating)
    IF NOT EXISTS (
      SELECT 1 FROM bars 
      WHERE slug = unique_slug 
        AND (p_existing_id IS NULL OR id != p_existing_id)
    ) THEN
      RETURN unique_slug;
    END IF;
    
    -- Try with counter
    unique_slug := base_slug || '-' || counter;
    counter := counter + 1;
  END LOOP;
  
  -- Fallback: use random suffix
  unique_slug := base_slug || '-' || substring(gen_random_uuid()::text, 1, 8);
  RETURN unique_slug;
END;
$$ LANGUAGE plpgsql;

-- Grant execute permission to authenticated users
GRANT EXECUTE ON FUNCTION generate_unique_slug TO authenticated;
GRANT EXECUTE ON FUNCTION generate_unique_slug TO service_role;

-- Verification: Check for any remaining collisions
WITH final_check AS (
  SELECT 
    slug,
    COUNT(*) as count
  FROM bars 
  WHERE slug IS NOT NULL AND slug != ''
  GROUP BY slug
  HAVING COUNT(*) > 1
)
SELECT 
  CASE 
    WHEN EXISTS (SELECT 1 FROM final_check) THEN 'ERROR: Collisions still exist'
    ELSE 'SUCCESS: All slugs are now unique'
  END as status,
  (SELECT COUNT(*) FROM final_check) as remaining_collisions;

-- Log the fix
INSERT INTO audit_logs (bar_id, action, details)
SELECT 
  NULL, -- System-level action
  'SECURITY_FIX_SLUG_UNIQUENESS',
  jsonb_build_object(
    'migration_version', '024',
    'fixed_at', NOW(),
    'description', 'Added UNIQUE constraint to bars.slug to prevent cross-bar access'
  )
WHERE EXISTS (SELECT 1 FROM information_schema.tables WHERE table_name = 'audit_logs');

COMMENT ON CONSTRAINT bars_slug_unique ON bars IS 'Security constraint: Prevents slug collisions that could redirect customers to wrong bars';
COMMENT ON FUNCTION generate_unique_slug IS 'Secure slug generation with collision detection and prevention';

-- Success message
SELECT 'CRITICAL SECURITY FIX APPLIED: Bar slug uniqueness enforced' as status;
